import{AnimationClip as e,Bone as t,Box3 as s,BufferAttribute as n,BufferGeometry as r,ClampToEdgeWrapping as i,Color as a,DirectionalLight as o,DoubleSide as l,FileLoader as u,FrontSide as c,Group as h,ImageBitmapLoader as d,InterleavedBuffer as p,InterleavedBufferAttribute as m,Interpolant as T,InterpolateDiscrete as f,InterpolateLinear as E,Line as g,LineBasicMaterial as S,LineLoop as x,LineSegments as R,LinearFilter as $,LinearMipmapLinearFilter as L,LinearMipmapNearestFilter as M,Loader as N,LoaderUtils as A,Material as I,MathUtils as v,Matrix4 as O,Mesh as y,MeshBasicMaterial as w,MeshPhysicalMaterial as b,MeshStandardMaterial as C,MirroredRepeatWrapping as F,NearestFilter as G,NearestMipmapLinearFilter as P,NearestMipmapNearestFilter as H,NumberKeyframeTrack as U,Object3D as _,OrthographicCamera as D,PerspectiveCamera as B,PointLight as k,Points as K,PointsMaterial as X,PropertyBinding as j,Quaternion as V,QuaternionKeyframeTrack as W,RepeatWrapping as z,Skeleton as Y,SkinnedMesh as q,Sphere as Q,SpotLight as Z,TangentSpaceNormalMap as J,Texture as ee,TextureLoader as et,TriangleFanDrawMode as es,TriangleStripDrawMode as en,Vector2 as er,Vector3 as ei,VectorKeyframeTrack as ea,sRGBEncoding as eo}from"./three.module.js";class GLTFLoader extends N{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new GLTFMaterialsClearcoatExtension(e)}),this.register(function(e){return new GLTFTextureBasisUExtension(e)}),this.register(function(e){return new GLTFTextureWebPExtension(e)}),this.register(function(e){return new GLTFMaterialsSheenExtension(e)}),this.register(function(e){return new GLTFMaterialsTransmissionExtension(e)}),this.register(function(e){return new GLTFMaterialsVolumeExtension(e)}),this.register(function(e){return new GLTFMaterialsIorExtension(e)}),this.register(function(e){return new GLTFMaterialsEmissiveStrengthExtension(e)}),this.register(function(e){return new GLTFMaterialsSpecularExtension(e)}),this.register(function(e){return new GLTFMaterialsIridescenceExtension(e)}),this.register(function(e){return new GLTFLightsExtension(e)}),this.register(function(e){return new GLTFMeshoptCompression(e)})}load(e,t,s,n){let r=this,i;i=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:A.extractUrlBase(e),this.manager.itemStart(e);let a=function(t){n?n(t):console.error(t),r.manager.itemError(e),r.manager.itemEnd(e)},o=new u(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,function(s){try{r.parse(s,i,function(s){t(s),r.manager.itemEnd(e)},a)}catch(n){a(n)}},s,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return -1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return -1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,n){let r,i={},a={};if("string"==typeof e)r=e;else{let o=A.decodeText(new Uint8Array(e,0,4));if(o===BINARY_EXTENSION_HEADER_MAGIC){try{i[EXTENSIONS.KHR_BINARY_GLTF]=new GLTFBinaryExtension(e)}catch(l){n&&n(l);return}r=i[EXTENSIONS.KHR_BINARY_GLTF].content}else r=A.decodeText(new Uint8Array(e))}let u=JSON.parse(r);if(void 0===u.asset||u.asset.version[0]<2){n&&n(Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}let c=new GLTFParser(u,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let h=0;h<this.pluginCallbacks.length;h++){let d=this.pluginCallbacks[h](c);a[d.name]=d,i[d.name]=!0}if(u.extensionsUsed)for(let p=0;p<u.extensionsUsed.length;++p){let m=u.extensionsUsed[p],T=u.extensionsRequired||[];switch(m){case EXTENSIONS.KHR_MATERIALS_UNLIT:i[m]=new GLTFMaterialsUnlitExtension;break;case EXTENSIONS.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:i[m]=new GLTFMaterialsPbrSpecularGlossinessExtension;break;case EXTENSIONS.KHR_DRACO_MESH_COMPRESSION:i[m]=new GLTFDracoMeshCompressionExtension(u,this.dracoLoader);break;case EXTENSIONS.KHR_TEXTURE_TRANSFORM:i[m]=new GLTFTextureTransformExtension;break;case EXTENSIONS.KHR_MESH_QUANTIZATION:i[m]=new GLTFMeshQuantizationExtension;break;default:T.indexOf(m)>=0&&void 0===a[m]&&console.warn('THREE.GLTFLoader: Unknown extension "'+m+'".')}}c.setExtensions(i),c.setPlugins(a),c.parse(s,n)}parseAsync(e,t){let s=this;return new Promise(function(n,r){s.parse(e,t,n,r)})}}function GLTFRegistry(){let e={};return{get:function(t){return e[t]},add:function(t,s){e[t]=s},remove:function(t){delete e[t]},removeAll:function(){e={}}}}let EXTENSIONS={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};class GLTFLightsExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){let e=this.parser,t=this.parser.json.nodes||[];for(let s=0,n=t.length;s<n;s++){let r=t[s];r.extensions&&r.extensions[this.name]&&void 0!==r.extensions[this.name].light&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){let t=this.parser,s="light:"+e,n=t.cache.get(s);if(n)return n;let r=t.json,i=r.extensions&&r.extensions[this.name]||{},l=i.lights||[],u=l[e],c,h=new a(16777215);void 0!==u.color&&h.fromArray(u.color);let d=void 0!==u.range?u.range:0;switch(u.type){case"directional":(c=new o(h)).target.position.set(0,0,-1),c.add(c.target);break;case"point":(c=new k(h)).distance=d;break;case"spot":(c=new Z(h)).distance=d,u.spot=u.spot||{},u.spot.innerConeAngle=void 0!==u.spot.innerConeAngle?u.spot.innerConeAngle:0,u.spot.outerConeAngle=void 0!==u.spot.outerConeAngle?u.spot.outerConeAngle:Math.PI/4,c.angle=u.spot.outerConeAngle,c.penumbra=1-u.spot.innerConeAngle/u.spot.outerConeAngle,c.target.position.set(0,0,-1),c.add(c.target);break;default:throw Error("THREE.GLTFLoader: Unexpected light type: "+u.type)}return c.position.set(0,0,0),c.decay=2,void 0!==u.intensity&&(c.intensity=u.intensity),c.name=t.createUniqueName(u.name||"light_"+e),n=Promise.resolve(c),t.cache.add(s,n),n}createNodeAttachment(e){let t=this,s=this.parser,n=s.json,r=n.nodes[e],i=r.extensions&&r.extensions[this.name]||{},a=i.light;return void 0===a?null:this._loadLight(a).then(function(e){return s._getNodeRef(t.cache,a,e)})}}class GLTFMaterialsUnlitExtension{constructor(){this.name=EXTENSIONS.KHR_MATERIALS_UNLIT}getMaterialType(){return w}extendParams(e,t,s){let n=[];e.color=new a(1,1,1),e.opacity=1;let r=t.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){let i=r.baseColorFactor;e.color.fromArray(i),e.opacity=i[3]}void 0!==r.baseColorTexture&&n.push(s.assignTexture(e,"map",r.baseColorTexture,eo))}return Promise.all(n)}}class GLTFMaterialsEmissiveStrengthExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){let s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name].emissiveStrength;return void 0!==r&&(t.emissiveIntensity=r),Promise.resolve()}}class GLTFMaterialsClearcoatExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){let t=this.parser,s=t.json.materials[e];return s.extensions&&s.extensions[this.name]?b:null}extendMaterialParams(e,t){let s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=[],i=n.extensions[this.name];if(void 0!==i.clearcoatFactor&&(t.clearcoat=i.clearcoatFactor),void 0!==i.clearcoatTexture&&r.push(s.assignTexture(t,"clearcoatMap",i.clearcoatTexture)),void 0!==i.clearcoatRoughnessFactor&&(t.clearcoatRoughness=i.clearcoatRoughnessFactor),void 0!==i.clearcoatRoughnessTexture&&r.push(s.assignTexture(t,"clearcoatRoughnessMap",i.clearcoatRoughnessTexture)),void 0!==i.clearcoatNormalTexture&&(r.push(s.assignTexture(t,"clearcoatNormalMap",i.clearcoatNormalTexture)),void 0!==i.clearcoatNormalTexture.scale)){let a=i.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new er(a,a)}return Promise.all(r)}}class GLTFMaterialsIridescenceExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){let t=this.parser,s=t.json.materials[e];return s.extensions&&s.extensions[this.name]?b:null}extendMaterialParams(e,t){let s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=[],i=n.extensions[this.name];return void 0!==i.iridescenceFactor&&(t.iridescence=i.iridescenceFactor),void 0!==i.iridescenceTexture&&r.push(s.assignTexture(t,"iridescenceMap",i.iridescenceTexture)),void 0!==i.iridescenceIor&&(t.iridescenceIOR=i.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==i.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=i.iridescenceThicknessMinimum),void 0!==i.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=i.iridescenceThicknessMaximum),void 0!==i.iridescenceThicknessTexture&&r.push(s.assignTexture(t,"iridescenceThicknessMap",i.iridescenceThicknessTexture)),Promise.all(r)}}class GLTFMaterialsSheenExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_SHEEN}getMaterialType(e){let t=this.parser,s=t.json.materials[e];return s.extensions&&s.extensions[this.name]?b:null}extendMaterialParams(e,t){let s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=[];t.sheenColor=new a(0,0,0),t.sheenRoughness=0,t.sheen=1;let i=n.extensions[this.name];return void 0!==i.sheenColorFactor&&t.sheenColor.fromArray(i.sheenColorFactor),void 0!==i.sheenRoughnessFactor&&(t.sheenRoughness=i.sheenRoughnessFactor),void 0!==i.sheenColorTexture&&r.push(s.assignTexture(t,"sheenColorMap",i.sheenColorTexture,eo)),void 0!==i.sheenRoughnessTexture&&r.push(s.assignTexture(t,"sheenRoughnessMap",i.sheenRoughnessTexture)),Promise.all(r)}}class GLTFMaterialsTransmissionExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){let t=this.parser,s=t.json.materials[e];return s.extensions&&s.extensions[this.name]?b:null}extendMaterialParams(e,t){let s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=[],i=n.extensions[this.name];return void 0!==i.transmissionFactor&&(t.transmission=i.transmissionFactor),void 0!==i.transmissionTexture&&r.push(s.assignTexture(t,"transmissionMap",i.transmissionTexture)),Promise.all(r)}}class GLTFMaterialsVolumeExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_VOLUME}getMaterialType(e){let t=this.parser,s=t.json.materials[e];return s.extensions&&s.extensions[this.name]?b:null}extendMaterialParams(e,t){let s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=[],i=n.extensions[this.name];t.thickness=void 0!==i.thicknessFactor?i.thicknessFactor:0,void 0!==i.thicknessTexture&&r.push(s.assignTexture(t,"thicknessMap",i.thicknessTexture)),t.attenuationDistance=i.attenuationDistance||0;let o=i.attenuationColor||[1,1,1];return t.attenuationColor=new a(o[0],o[1],o[2]),Promise.all(r)}}class GLTFMaterialsIorExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_IOR}getMaterialType(e){let t=this.parser,s=t.json.materials[e];return s.extensions&&s.extensions[this.name]?b:null}extendMaterialParams(e,t){let s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name];return t.ior=void 0!==r.ior?r.ior:1.5,Promise.resolve()}}class GLTFMaterialsSpecularExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_SPECULAR}getMaterialType(e){let t=this.parser,s=t.json.materials[e];return s.extensions&&s.extensions[this.name]?b:null}extendMaterialParams(e,t){let s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=[],i=n.extensions[this.name];t.specularIntensity=void 0!==i.specularFactor?i.specularFactor:1,void 0!==i.specularTexture&&r.push(s.assignTexture(t,"specularIntensityMap",i.specularTexture));let o=i.specularColorFactor||[1,1,1];return t.specularColor=new a(o[0],o[1],o[2]),void 0!==i.specularColorTexture&&r.push(s.assignTexture(t,"specularColorMap",i.specularColorTexture,eo)),Promise.all(r)}}class GLTFTextureBasisUExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_TEXTURE_BASISU}loadTexture(e){let t=this.parser,s=t.json,n=s.textures[e];if(!n.extensions||!n.extensions[this.name])return null;let r=n.extensions[this.name],i=t.options.ktx2Loader;if(!i){if(!(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0))return null;throw Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures")}return t.loadTextureImage(e,r.source,i)}}class GLTFTextureWebPExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){let t=this.name,s=this.parser,n=s.json,r=n.textures[e];if(!r.extensions||!r.extensions[t])return null;let i=r.extensions[t],a=n.images[i.source],o=s.textureLoader;if(a.uri){let l=s.options.manager.getHandler(a.uri);null!==l&&(o=l)}return this.detectSupport().then(function(r){if(r)return s.loadTextureImage(e,i.source,o);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){let t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}}class GLTFMeshoptCompression{constructor(e){this.name=EXTENSIONS.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){let t=this.parser.json,s=t.bufferViews[e];if(!s.extensions||!s.extensions[this.name])return null;{let n=s.extensions[this.name],r=this.parser.getDependency("buffer",n.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported){if(!(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0))return null;throw Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files")}return r.then(function(e){let t=n.byteOffset||0,s=n.byteLength||0,r=n.count,a=n.byteStride,o=new Uint8Array(e,t,s);return i.decodeGltfBufferAsync?i.decodeGltfBufferAsync(r,a,o,n.mode,n.filter).then(function(e){return e.buffer}):i.ready.then(function(){let e=new ArrayBuffer(r*a);return i.decodeGltfBuffer(new Uint8Array(e),r,a,o,n.mode,n.filter),e})})}}}let BINARY_EXTENSION_HEADER_MAGIC="glTF",BINARY_EXTENSION_HEADER_LENGTH=12,BINARY_EXTENSION_CHUNK_TYPES={JSON:1313821514,BIN:5130562};class GLTFBinaryExtension{constructor(e){this.name=EXTENSIONS.KHR_BINARY_GLTF,this.content=null,this.body=null;let t=new DataView(e,0,12);if(this.header={magic:A.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==BINARY_EXTENSION_HEADER_MAGIC)throw Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw Error("THREE.GLTFLoader: Legacy binary file detected.");let s=this.header.length-12,n=new DataView(e,12),r=0;for(;r<s;){let i=n.getUint32(r,!0);r+=4;let a=n.getUint32(r,!0);if(r+=4,a===BINARY_EXTENSION_CHUNK_TYPES.JSON){let o=new Uint8Array(e,12+r,i);this.content=A.decodeText(o)}else if(a===BINARY_EXTENSION_CHUNK_TYPES.BIN){let l=12+r;this.body=e.slice(l,l+i)}r+=i}if(null===this.content)throw Error("THREE.GLTFLoader: JSON content not found.")}}class GLTFDracoMeshCompressionExtension{constructor(e,t){if(!t)throw Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=EXTENSIONS.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){let s=this.json,n=this.dracoLoader,r=e.extensions[this.name].bufferView,i=e.extensions[this.name].attributes,a={},o={},l={};for(let u in i){let c=ATTRIBUTES[u]||u.toLowerCase();a[c]=i[u]}for(let h in e.attributes){let d=ATTRIBUTES[h]||h.toLowerCase();if(void 0!==i[h]){let p=s.accessors[e.attributes[h]],m=WEBGL_COMPONENT_TYPES[p.componentType];l[d]=m.name,o[d]=!0===p.normalized}}return t.getDependency("bufferView",r).then(function(e){return new Promise(function(t){n.decodeDracoFile(e,function(e){for(let s in e.attributes){let n=e.attributes[s],r=o[s];void 0!==r&&(n.normalized=r)}t(e)},a,l)})})}}class GLTFTextureTransformExtension{constructor(){this.name=EXTENSIONS.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class GLTFMeshStandardSGMaterial extends C{constructor(e){super(),this.isGLTFSpecularGlossinessMaterial=!0;let t={specular:{value:new a().setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=t,this.onBeforeCompile=function(e){for(let s in t)e.uniforms[s]=t[s];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>","#ifdef USE_SPECULARMAP\n	uniform sampler2D specularMap;\n#endif").replace("#include <metalnessmap_pars_fragment>","#ifdef USE_GLOSSINESSMAP\n	uniform sampler2D glossinessMap;\n#endif").replace("#include <roughnessmap_fragment>","vec3 specularFactor = specular;\n#ifdef USE_SPECULARMAP\n	vec4 texelSpecular = texture2D( specularMap, vUv );\n	// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture\n	specularFactor *= texelSpecular.rgb;\n#endif").replace("#include <metalnessmap_fragment>","float glossinessFactor = glossiness;\n#ifdef USE_GLOSSINESSMAP\n	vec4 texelGlossiness = texture2D( glossinessMap, vUv );\n	// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture\n	glossinessFactor *= texelGlossiness.a;\n#endif").replace("#include <lights_physical_fragment>","PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );\nvec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\nmaterial.roughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.\nmaterial.roughness += geometryRoughness;\nmaterial.roughness = min( material.roughness, 1.0 );\nmaterial.specularColor = specularFactor;")},Object.defineProperties(this,{specular:{get:function(){return t.specular.value},set:function(e){t.specular.value=e}},specularMap:{get:function(){return t.specularMap.value},set:function(e){t.specularMap.value=e,e?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return t.glossiness.value},set:function(e){t.glossiness.value=e}},glossinessMap:{get:function(){return t.glossinessMap.value},set:function(e){t.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}copy(e){return super.copy(e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this}}class GLTFMaterialsPbrSpecularGlossinessExtension{constructor(){this.name=EXTENSIONS.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,this.specularGlossinessParams=["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity"]}getMaterialType(){return GLTFMeshStandardSGMaterial}extendParams(e,t,s){let n=t.extensions[this.name];e.color=new a(1,1,1),e.opacity=1;let r=[];if(Array.isArray(n.diffuseFactor)){let i=n.diffuseFactor;e.color.fromArray(i),e.opacity=i[3]}if(void 0!==n.diffuseTexture&&r.push(s.assignTexture(e,"map",n.diffuseTexture,eo)),e.emissive=new a(0,0,0),e.glossiness=void 0!==n.glossinessFactor?n.glossinessFactor:1,e.specular=new a(1,1,1),Array.isArray(n.specularFactor)&&e.specular.fromArray(n.specularFactor),void 0!==n.specularGlossinessTexture){let o=n.specularGlossinessTexture;r.push(s.assignTexture(e,"glossinessMap",o)),r.push(s.assignTexture(e,"specularMap",o,eo))}return Promise.all(r)}createMaterial(e){let t=new GLTFMeshStandardSGMaterial(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=void 0===e.emissiveIntensity?1:e.emissiveIntensity,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=J,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t}}class GLTFMeshQuantizationExtension{constructor(){this.name=EXTENSIONS.KHR_MESH_QUANTIZATION}}class GLTFCubicSplineInterpolant extends T{constructor(e,t,s,n){super(e,t,s,n)}copySampleValue_(e){let t=this.resultBuffer,s=this.sampleValues,n=this.valueSize,r=e*n*3+n;for(let i=0;i!==n;i++)t[i]=s[r+i];return t}interpolate_(e,t,s,n){let r=this.resultBuffer,i=this.sampleValues,a=this.valueSize,o=2*a,l=3*a,u=n-t,c=(s-t)/u,h=c*c,d=h*c,p=e*l,m=p-l,T=-2*d+3*h,f=d-h,E=1-T,g=f-h+c;for(let S=0;S!==a;S++){let x=i[m+S+a],R=i[m+S+o]*u,$=i[p+S+a],L=i[p+S]*u;r[S]=E*x+g*R+T*$+f*L}return r}}let _q=new V;class GLTFCubicSplineQuaternionInterpolant extends GLTFCubicSplineInterpolant{interpolate_(e,t,s,n){let r=super.interpolate_(e,t,s,n);return _q.fromArray(r).normalize().toArray(r),r}}let WEBGL_CONSTANTS={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},WEBGL_COMPONENT_TYPES={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},WEBGL_FILTERS={9728:G,9729:$,9984:H,9985:M,9986:P,9987:L},WEBGL_WRAPPINGS={33071:i,33648:F,10497:z},WEBGL_TYPE_SIZES={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ATTRIBUTES={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},PATH_PROPERTIES={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},INTERPOLATION={CUBICSPLINE:void 0,LINEAR:E,STEP:f},ALPHA_MODES={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function createDefaultMaterial(e){return void 0===e.DefaultMaterial&&(e.DefaultMaterial=new C({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:c})),e.DefaultMaterial}function addUnknownExtensionsToUserData(e,t,s){for(let n in s.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=s.extensions[n])}function assignExtrasToUserData(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function addMorphTargets(e,t,s){let n=!1,r=!1,i=!1;for(let a=0,o=t.length;a<o;a++){let l=t[a];if(void 0!==l.POSITION&&(n=!0),void 0!==l.NORMAL&&(r=!0),void 0!==l.COLOR_0&&(i=!0),n&&r&&i)break}if(!n&&!r&&!i)return Promise.resolve(e);let u=[],c=[],h=[];for(let d=0,p=t.length;d<p;d++){let m=t[d];if(n){let T=void 0!==m.POSITION?s.getDependency("accessor",m.POSITION):e.attributes.position;u.push(T)}if(r){let f=void 0!==m.NORMAL?s.getDependency("accessor",m.NORMAL):e.attributes.normal;c.push(f)}if(i){let E=void 0!==m.COLOR_0?s.getDependency("accessor",m.COLOR_0):e.attributes.color;h.push(E)}}return Promise.all([Promise.all(u),Promise.all(c),Promise.all(h)]).then(function(t){let s=t[0],a=t[1],o=t[2];return n&&(e.morphAttributes.position=s),r&&(e.morphAttributes.normal=a),i&&(e.morphAttributes.color=o),e.morphTargetsRelative=!0,e})}function updateMorphTargets(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let s=0,n=t.weights.length;s<n;s++)e.morphTargetInfluences[s]=t.weights[s];if(t.extras&&Array.isArray(t.extras.targetNames)){let r=t.extras.targetNames;if(e.morphTargetInfluences.length===r.length){e.morphTargetDictionary={};for(let i=0,a=r.length;i<a;i++)e.morphTargetDictionary[r[i]]=i}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function createPrimitiveKey(e){let t=e.extensions&&e.extensions[EXTENSIONS.KHR_DRACO_MESH_COMPRESSION],s;return t?"draco:"+t.bufferView+":"+t.indices+":"+createAttributesKey(t.attributes):e.indices+":"+createAttributesKey(e.attributes)+":"+e.mode}function createAttributesKey(e){let t="",s=Object.keys(e).sort();for(let n=0,r=s.length;n<r;n++)t+=s[n]+":"+e[s[n]]+";";return t}function getNormalizedComponentScale(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function getImageURIMimeType(e){return e.search(/\.jpe?g($|\?)/i)>0||0===e.search(/^data\:image\/jpeg/)?"image/jpeg":e.search(/\.webp($|\?)/i)>0||0===e.search(/^data\:image\/webp/)?"image/webp":"image/png"}class GLTFParser{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new GLTFRegistry,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),n=navigator.userAgent.indexOf("Firefox")>-1,r=n?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1;"undefined"==typeof createImageBitmap||s||n&&r<98?this.textureLoader=new et(this.options.manager):this.textureLoader=new d(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new u(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){let s=this,n=this.json,r=this.extensions;this.cache.removeAll(),this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera"),])}).then(function(t){let i={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:s,userData:{}};addUnknownExtensionsToUserData(r,i,n),assignExtrasToUserData(i,n),Promise.all(s._invokeAll(function(e){return e.afterRoot&&e.afterRoot(i)})).then(function(){e(i)})}).catch(t)}_markDefs(){let e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let n=0,r=t.length;n<r;n++){let i=t[n].joints;for(let a=0,o=i.length;a<o;a++)e[i[a]].isBone=!0}for(let l=0,u=e.length;l<u;l++){let c=e[l];void 0!==c.mesh&&(this._addNodeRef(this.meshCache,c.mesh),void 0!==c.skin&&(s[c.mesh].isSkinnedMesh=!0)),void 0!==c.camera&&this._addNodeRef(this.cameraCache,c.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;let n=s.clone(),r=(e,t)=>{let s=this.associations.get(e);for(let[n,i]of(null!=s&&this.associations.set(t,s),e.children.entries()))r(i,t.children[n])};return r(s,n),n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){let t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){let n=e(t[s]);if(n)return n}return null}_invokeAll(e){let t=Object.values(this.plugins);t.unshift(this);let s=[];for(let n=0;n<t.length;n++){let r=e(t[n]);r&&s.push(r)}return s}getDependency(e,t){let s=e+":"+t,n=this.cache.get(s);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this.loadNode(t);break;case"mesh":n=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":n=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne(function(e){return e.loadAnimation&&e.loadAnimation(t)});break;case"camera":n=this.loadCamera(t);break;default:throw Error("Unknown type: "+e)}this.cache.add(s,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){let s=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map(function(t,n){return s.getDependency(e,n)})),this.cache.add(e,t)}return t}loadBuffer(e){let t=this.json.buffers[e],s=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[EXTENSIONS.KHR_BINARY_GLTF].body);let n=this.options;return new Promise(function(e,r){s.load(A.resolveURL(t.uri,n.path),e,void 0,function(){r(Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){let t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){let s=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+s)})}loadAccessor(e){let t=this,s=this.json,r=this.json.accessors[e];if(void 0===r.bufferView&&void 0===r.sparse)return Promise.resolve(null);let i=[];return void 0!==r.bufferView?i.push(this.getDependency("bufferView",r.bufferView)):i.push(null),void 0!==r.sparse&&(i.push(this.getDependency("bufferView",r.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",r.sparse.values.bufferView))),Promise.all(i).then(function(e){let i=e[0],a=WEBGL_TYPE_SIZES[r.type],o=WEBGL_COMPONENT_TYPES[r.componentType],l=o.BYTES_PER_ELEMENT,u=r.byteOffset||0,c=void 0!==r.bufferView?s.bufferViews[r.bufferView].byteStride:void 0,h=!0===r.normalized,d,T;if(c&&c!==l*a){let f=Math.floor(u/c),E="InterleavedBuffer:"+r.bufferView+":"+r.componentType+":"+f+":"+r.count,g=t.cache.get(E);g||(d=new o(i,f*c,r.count*c/l),g=new p(d,c/l),t.cache.add(E,g)),T=new m(g,a,u%c/l,h)}else d=null===i?new o(r.count*a):new o(i,u,r.count*a),T=new n(d,a,h);if(void 0!==r.sparse){let S=WEBGL_TYPE_SIZES.SCALAR,x=WEBGL_COMPONENT_TYPES[r.sparse.indices.componentType],R=r.sparse.indices.byteOffset||0,$=r.sparse.values.byteOffset||0,L=new x(e[1],R,r.sparse.count*S),M=new o(e[2],$,r.sparse.count*a);null!==i&&(T=new n(T.array.slice(),T.itemSize,T.normalized));for(let N=0,A=L.length;N<A;N++){let I=L[N];if(T.setX(I,M[N*a]),a>=2&&T.setY(I,M[N*a+1]),a>=3&&T.setZ(I,M[N*a+2]),a>=4&&T.setW(I,M[N*a+3]),a>=5)throw Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return T})}loadTexture(e){let t=this.json,s=this.options,n=t.textures[e],r=n.source,i=t.images[r],a=this.textureLoader;if(i.uri){let o=s.manager.getHandler(i.uri);null!==o&&(a=o)}return this.loadTextureImage(e,r,a)}loadTextureImage(e,t,s){let n=this,r=this.json,i=r.textures[e],a=r.images[t],o=(a.uri||a.bufferView)+":"+i.sampler;if(this.textureCache[o])return this.textureCache[o];let l=this.loadImageSource(t,s).then(function(t){t.flipY=!1,i.name&&(t.name=i.name);let s=r.samplers||{},a=s[i.sampler]||{};return t.magFilter=WEBGL_FILTERS[a.magFilter]||$,t.minFilter=WEBGL_FILTERS[a.minFilter]||L,t.wrapS=WEBGL_WRAPPINGS[a.wrapS]||z,t.wrapT=WEBGL_WRAPPINGS[a.wrapT]||z,n.associations.set(t,{textures:e}),t}).catch(function(){return null});return this.textureCache[o]=l,l}loadImageSource(e,t){let s=this.json,n=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then(e=>e.clone());let r=s.images[e],i=self.URL||self.webkitURL,a=r.uri||"",o=!1;if(void 0!==r.bufferView)a=this.getDependency("bufferView",r.bufferView).then(function(e){o=!0;let t=new Blob([e],{type:r.mimeType});return a=i.createObjectURL(t)});else if(void 0===r.uri)throw Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");let l=Promise.resolve(a).then(function(e){return new Promise(function(s,r){let i=s;!0===t.isImageBitmapLoader&&(i=function(e){let t=new ee(e);t.needsUpdate=!0,s(t)}),t.load(A.resolveURL(e,n.path),i,void 0,r)})}).then(function(e){return!0===o&&i.revokeObjectURL(a),e.userData.mimeType=r.mimeType||getImageURIMimeType(r.uri),e}).catch(function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),e});return this.sourceCache[e]=l,l}assignTexture(e,t,s,n){let r=this;return this.getDependency("texture",s.index).then(function(i){if(void 0===s.texCoord||0==s.texCoord||"aoMap"===t&&1==s.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+s.texCoord+" for texture "+t+" not yet supported."),r.extensions[EXTENSIONS.KHR_TEXTURE_TRANSFORM]){let a=void 0!==s.extensions?s.extensions[EXTENSIONS.KHR_TEXTURE_TRANSFORM]:void 0;if(a){let o=r.associations.get(i);i=r.extensions[EXTENSIONS.KHR_TEXTURE_TRANSFORM].extendTexture(i,a),r.associations.set(i,o)}}return void 0!==n&&(i.encoding=n),e[t]=i,i})}assignFinalMaterial(e){let t=e.geometry,s=e.material,n=void 0===t.attributes.tangent,r=void 0!==t.attributes.color,i=void 0===t.attributes.normal;if(e.isPoints){let a="PointsMaterial:"+s.uuid,o=this.cache.get(a);o||(o=new X,I.prototype.copy.call(o,s),o.color.copy(s.color),o.map=s.map,o.sizeAttenuation=!1,this.cache.add(a,o)),s=o}else if(e.isLine){let l="LineBasicMaterial:"+s.uuid,u=this.cache.get(l);u||(u=new S,I.prototype.copy.call(u,s),u.color.copy(s.color),this.cache.add(l,u)),s=u}if(n||r||i){let c="ClonedMaterial:"+s.uuid+":";s.isGLTFSpecularGlossinessMaterial&&(c+="specular-glossiness:"),n&&(c+="derivative-tangents:"),r&&(c+="vertex-colors:"),i&&(c+="flat-shading:");let h=this.cache.get(c);h||(h=s.clone(),r&&(h.vertexColors=!0),i&&(h.flatShading=!0),n&&(h.normalScale&&(h.normalScale.y*=-1),h.clearcoatNormalScale&&(h.clearcoatNormalScale.y*=-1)),this.cache.add(c,h),this.associations.set(h,this.associations.get(s))),s=h}s.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),e.material=s}getMaterialType(){return C}loadMaterial(e){let t=this,s=this.json,n=this.extensions,r=s.materials[e],i,o={},u=r.extensions||{},c=[];if(u[EXTENSIONS.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){let h=n[EXTENSIONS.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];i=h.getMaterialType(),c.push(h.extendParams(o,r,t))}else if(u[EXTENSIONS.KHR_MATERIALS_UNLIT]){let d=n[EXTENSIONS.KHR_MATERIALS_UNLIT];i=d.getMaterialType(),c.push(d.extendParams(o,r,t))}else{let p=r.pbrMetallicRoughness||{};if(o.color=new a(1,1,1),o.opacity=1,Array.isArray(p.baseColorFactor)){let m=p.baseColorFactor;o.color.fromArray(m),o.opacity=m[3]}void 0!==p.baseColorTexture&&c.push(t.assignTexture(o,"map",p.baseColorTexture,eo)),o.metalness=void 0!==p.metallicFactor?p.metallicFactor:1,o.roughness=void 0!==p.roughnessFactor?p.roughnessFactor:1,void 0!==p.metallicRoughnessTexture&&(c.push(t.assignTexture(o,"metalnessMap",p.metallicRoughnessTexture)),c.push(t.assignTexture(o,"roughnessMap",p.metallicRoughnessTexture))),i=this._invokeOne(function(t){return t.getMaterialType&&t.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,o)})))}!0===r.doubleSided&&(o.side=l);let T=r.alphaMode||ALPHA_MODES.OPAQUE;if(T===ALPHA_MODES.BLEND?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,T===ALPHA_MODES.MASK&&(o.alphaTest=void 0!==r.alphaCutoff?r.alphaCutoff:.5)),void 0!==r.normalTexture&&i!==w&&(c.push(t.assignTexture(o,"normalMap",r.normalTexture)),o.normalScale=new er(1,1),void 0!==r.normalTexture.scale)){let f=r.normalTexture.scale;o.normalScale.set(f,f)}return void 0!==r.occlusionTexture&&i!==w&&(c.push(t.assignTexture(o,"aoMap",r.occlusionTexture)),void 0!==r.occlusionTexture.strength&&(o.aoMapIntensity=r.occlusionTexture.strength)),void 0!==r.emissiveFactor&&i!==w&&(o.emissive=new a().fromArray(r.emissiveFactor)),void 0!==r.emissiveTexture&&i!==w&&c.push(t.assignTexture(o,"emissiveMap",r.emissiveTexture,eo)),Promise.all(c).then(function(){let s;return s=i===GLTFMeshStandardSGMaterial?n[EXTENSIONS.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(o):new i(o),r.name&&(s.name=r.name),assignExtrasToUserData(s,r),t.associations.set(s,{materials:e}),r.extensions&&addUnknownExtensionsToUserData(n,s,r),s})}createUniqueName(e){let t=j.sanitizeNodeName(e||""),s=t;for(let n=1;this.nodeNamesUsed[s];++n)s=t+"_"+n;return this.nodeNamesUsed[s]=!0,s}loadGeometries(e){let t=this,s=this.extensions,n=this.primitiveCache;function i(e){return s[EXTENSIONS.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(s){return addPrimitiveAttributes(s,e,t)})}let a=[];for(let o=0,l=e.length;o<l;o++){let u=e[o],c=createPrimitiveKey(u),h=n[c];if(h)a.push(h.promise);else{let d;d=u.extensions&&u.extensions[EXTENSIONS.KHR_DRACO_MESH_COMPRESSION]?i(u):addPrimitiveAttributes(new r,u,t),n[c]={primitive:u,promise:d},a.push(d)}}return Promise.all(a)}loadMesh(e){let t=this,s=this.json,n=this.extensions,r=s.meshes[e],i=r.primitives,a=[];for(let o=0,l=i.length;o<l;o++){let u=void 0===i[o].material?createDefaultMaterial(this.cache):this.getDependency("material",i[o].material);a.push(u)}return a.push(t.loadGeometries(i)),Promise.all(a).then(function(s){let a=s.slice(0,s.length-1),o=s[s.length-1],l=[];for(let u=0,c=o.length;u<c;u++){let d=o[u],p=i[u],m,T=a[u];if(p.mode===WEBGL_CONSTANTS.TRIANGLES||p.mode===WEBGL_CONSTANTS.TRIANGLE_STRIP||p.mode===WEBGL_CONSTANTS.TRIANGLE_FAN||void 0===p.mode)!0!==(m=!0===r.isSkinnedMesh?new q(d,T):new y(d,T)).isSkinnedMesh||m.geometry.attributes.skinWeight.normalized||m.normalizeSkinWeights(),p.mode===WEBGL_CONSTANTS.TRIANGLE_STRIP?m.geometry=toTrianglesDrawMode(m.geometry,en):p.mode===WEBGL_CONSTANTS.TRIANGLE_FAN&&(m.geometry=toTrianglesDrawMode(m.geometry,es));else if(p.mode===WEBGL_CONSTANTS.LINES)m=new R(d,T);else if(p.mode===WEBGL_CONSTANTS.LINE_STRIP)m=new g(d,T);else if(p.mode===WEBGL_CONSTANTS.LINE_LOOP)m=new x(d,T);else if(p.mode===WEBGL_CONSTANTS.POINTS)m=new K(d,T);else throw Error("THREE.GLTFLoader: Primitive mode unsupported: "+p.mode);Object.keys(m.geometry.morphAttributes).length>0&&updateMorphTargets(m,r),m.name=t.createUniqueName(r.name||"mesh_"+e),assignExtrasToUserData(m,r),p.extensions&&addUnknownExtensionsToUserData(n,m,p),t.assignFinalMaterial(m),l.push(m)}for(let f=0,E=l.length;f<E;f++)t.associations.set(l[f],{meshes:e,primitives:f});if(1===l.length)return l[0];let S=new h;t.associations.set(S,{meshes:e});for(let $=0,L=l.length;$<L;$++)S.add(l[$]);return S})}loadCamera(e){let t,s=this.json.cameras[e],n=s[s.type];if(!n){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return"perspective"===s.type?t=new B(v.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===s.type&&(t=new D(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),assignExtrasToUserData(t,s),Promise.resolve(t)}loadSkin(e){let t=this.json.skins[e],s={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(s):this.getDependency("accessor",t.inverseBindMatrices).then(function(e){return s.inverseBindMatrices=e,s})}loadAnimation(t){let s=this.json,n=s.animations[t],r=[],i=[],a=[],o=[],l=[];for(let u=0,c=n.channels.length;u<c;u++){let h=n.channels[u],d=n.samplers[h.sampler],p=h.target,m=p.node,T=void 0!==n.parameters?n.parameters[d.input]:d.input,f=void 0!==n.parameters?n.parameters[d.output]:d.output;r.push(this.getDependency("node",m)),i.push(this.getDependency("accessor",T)),a.push(this.getDependency("accessor",f)),o.push(d),l.push(p)}return Promise.all([Promise.all(r),Promise.all(i),Promise.all(a),Promise.all(o),Promise.all(l)]).then(function(s){let r=s[0],i=s[1],a=s[2],o=s[3],l=s[4],u=[];for(let c=0,h=r.length;c<h;c++){let d=r[c],p=i[c],m=a[c],T=o[c],f=l[c];if(void 0===d)continue;d.updateMatrix();let g;switch(PATH_PROPERTIES[f.path]){case PATH_PROPERTIES.weights:g=U;break;case PATH_PROPERTIES.rotation:g=W;break;case PATH_PROPERTIES.position:case PATH_PROPERTIES.scale:default:g=ea}let S=d.name?d.name:d.uuid,x=void 0!==T.interpolation?INTERPOLATION[T.interpolation]:E,R=[];PATH_PROPERTIES[f.path]===PATH_PROPERTIES.weights?d.traverse(function(e){e.morphTargetInfluences&&R.push(e.name?e.name:e.uuid)}):R.push(S);let $=m.array;if(m.normalized){let L=getNormalizedComponentScale($.constructor),M=new Float32Array($.length);for(let N=0,A=$.length;N<A;N++)M[N]=$[N]*L;$=M}for(let I=0,v=R.length;I<v;I++){let O=new g(R[I]+"."+PATH_PROPERTIES[f.path],p.array,$,x);"CUBICSPLINE"===T.interpolation&&(O.createInterpolant=function e(t){let s=this instanceof W?GLTFCubicSplineQuaternionInterpolant:GLTFCubicSplineInterpolant;return new s(this.times,this.values,this.getValueSize()/3,t)},O.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),u.push(O)}}let y=n.name?n.name:"animation_"+t;return new e(y,void 0,u)})}createNodeMesh(e){let t=this.json,s=this,n=t.nodes[e];return void 0===n.mesh?null:s.getDependency("mesh",n.mesh).then(function(e){let t=s._getNodeRef(s.meshCache,n.mesh,e);return void 0!==n.weights&&t.traverse(function(e){if(e.isMesh)for(let t=0,s=n.weights.length;t<s;t++)e.morphTargetInfluences[t]=n.weights[t]}),t})}loadNode(e){let s=this.json,n=this.extensions,r=this,i=s.nodes[e],a=i.name?r.createUniqueName(i.name):"";return(function(){let t=[],s=r._invokeOne(function(t){return t.createNodeMesh&&t.createNodeMesh(e)});return s&&t.push(s),void 0!==i.camera&&t.push(r.getDependency("camera",i.camera).then(function(e){return r._getNodeRef(r.cameraCache,i.camera,e)})),r._invokeAll(function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)}).forEach(function(e){t.push(e)}),Promise.all(t)})().then(function(s){let o;if((o=!0===i.isBone?new t:s.length>1?new h:1===s.length?s[0]:new _)!==s[0])for(let l=0,u=s.length;l<u;l++)o.add(s[l]);if(i.name&&(o.userData.name=i.name,o.name=a),assignExtrasToUserData(o,i),i.extensions&&addUnknownExtensionsToUserData(n,o,i),void 0!==i.matrix){let c=new O;c.fromArray(i.matrix),o.applyMatrix4(c)}else void 0!==i.translation&&o.position.fromArray(i.translation),void 0!==i.rotation&&o.quaternion.fromArray(i.rotation),void 0!==i.scale&&o.scale.fromArray(i.scale);return r.associations.has(o)||r.associations.set(o,{}),r.associations.get(o).nodes=e,o})}loadScene(e){let t=this.json,s=this.extensions,n=this.json.scenes[e],r=this,i=new h;n.name&&(i.name=r.createUniqueName(n.name)),assignExtrasToUserData(i,n),n.extensions&&addUnknownExtensionsToUserData(s,i,n);let a=n.nodes||[],o=[];for(let l=0,u=a.length;l<u;l++)o.push(buildNodeHierarchy(a[l],i,t,r));return Promise.all(o).then(function(){return r.associations=(e=>{let t=new Map;for(let[s,n]of r.associations)(s instanceof I||s instanceof ee)&&t.set(s,n);return e.traverse(e=>{let s=r.associations.get(e);null!=s&&t.set(e,s)}),t})(i),i})}}function buildNodeHierarchy(e,t,s,n){let r=s.nodes[e];return n.getDependency("node",e).then(function(e){if(void 0===r.skin)return e;let t;return n.getDependency("skin",r.skin).then(function(e){t=e;let s=[];for(let r=0,i=t.joints.length;r<i;r++)s.push(n.getDependency("node",t.joints[r]));return Promise.all(s)}).then(function(s){return e.traverse(function(e){if(!e.isMesh)return;let n=[],r=[];for(let i=0,a=s.length;i<a;i++){let o=s[i];if(o){n.push(o);let l=new O;void 0!==t.inverseBindMatrices&&l.fromArray(t.inverseBindMatrices.array,16*i),r.push(l)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[i])}e.bind(new Y(n,r),e.matrixWorld)}),e})}).then(function(e){t.add(e);let i=[];if(r.children){let a=r.children;for(let o=0,l=a.length;o<l;o++){let u=a[o];i.push(buildNodeHierarchy(u,e,s,n))}}return Promise.all(i)})}function computeBounds(e,t,n){let r=t.attributes,i=new s;if(void 0===r.POSITION)return;{let a=n.json.accessors[r.POSITION],o=a.min,l=a.max;if(void 0!==o&&void 0!==l){if(i.set(new ei(o[0],o[1],o[2]),new ei(l[0],l[1],l[2])),a.normalized){let u=getNormalizedComponentScale(WEBGL_COMPONENT_TYPES[a.componentType]);i.min.multiplyScalar(u),i.max.multiplyScalar(u)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}let c=t.targets;if(void 0!==c){let h=new ei,d=new ei;for(let p=0,m=c.length;p<m;p++){let T=c[p];if(void 0!==T.POSITION){let f=n.json.accessors[T.POSITION],E=f.min,g=f.max;if(void 0!==E&&void 0!==g){if(d.setX(Math.max(Math.abs(E[0]),Math.abs(g[0]))),d.setY(Math.max(Math.abs(E[1]),Math.abs(g[1]))),d.setZ(Math.max(Math.abs(E[2]),Math.abs(g[2]))),f.normalized){let S=getNormalizedComponentScale(WEBGL_COMPONENT_TYPES[f.componentType]);d.multiplyScalar(S)}h.max(d)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}i.expandByVector(h)}e.boundingBox=i;let x=new Q;i.getCenter(x.center),x.radius=i.min.distanceTo(i.max)/2,e.boundingSphere=x}function addPrimitiveAttributes(e,t,s){let n=t.attributes,r=[];function i(t,n){return s.getDependency("accessor",t).then(function(t){e.setAttribute(n,t)})}for(let a in n){let o=ATTRIBUTES[a]||a.toLowerCase();o in e.attributes||r.push(i(n[a],o))}if(void 0!==t.indices&&!e.index){let l=s.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});r.push(l)}return assignExtrasToUserData(e,t),computeBounds(e,t,s),Promise.all(r).then(function(){return void 0!==t.targets?addMorphTargets(e,t.targets,s):e})}function toTrianglesDrawMode(e,t){let s=e.getIndex();if(null===s){let n=[],r=e.getAttribute("position");if(void 0===r)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let i=0;i<r.count;i++)n.push(i);e.setIndex(n),s=e.getIndex()}let a=s.count-2,o=[];if(t===es)for(let l=1;l<=a;l++)o.push(s.getX(0)),o.push(s.getX(l)),o.push(s.getX(l+1));else for(let u=0;u<a;u++)u%2==0?(o.push(s.getX(u)),o.push(s.getX(u+1)),o.push(s.getX(u+2))):(o.push(s.getX(u+2)),o.push(s.getX(u+1)),o.push(s.getX(u)));o.length/3!==a&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");let c=e.clone();return c.setIndex(o),c}export{GLTFLoader};